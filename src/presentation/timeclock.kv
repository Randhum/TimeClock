#:import DebouncedButton src.presentation.widgets.DebouncedButton
#:import FilteredTextInput src.presentation.widgets.FilteredTextInput
#:import ScreensaverScreen src.presentation.screens.screensaver_screen.ScreensaverScreen
#:import MatrixRain src.presentation.screens.screensaver_screen.MatrixRain

WindowManager:
    TimeClockScreen:
    AdminScreen:
    RegisterScreen:
    IdentifyScreen:
    WTReportSelectEmployeeScreen:
    WTReportSelectDatesScreen:
    WTReportDisplayScreen:
    ScreensaverScreen:

# Global Styles
<Button>:
    font_size: 24
    size_hint_y: None
    height: '80dp'

<DebouncedButton>:
    font_size: 24
    size_hint_y: None
    height: '80dp'

<Label>:
    font_size: 24

<GreeterPopup>:
    title: ""
    separator_height: 0
    size_hint: 0.8, 0.7
    background_color: 0, 0, 0, 0.8 # Transparent dark bg
    
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 10
        
        Label:
            text: root.greeting
            font_size: '50sp'
            bold: True
            color: root.color_theme
            halign: 'center'
            
        Label:
            text: root.message
            font_size: '30sp'
            color: 1, 1, 1, 1
            halign: 'center'
            valign: 'middle'
            text_size: self.width, None
            size_hint_y: None
            height: self.texture_size[1] if self.texture_size else '50dp'

# TimeClock Main Screen
<TimeClockScreen>:
    name: "timeclock"
    BoxLayout:
        orientation: "vertical"
        padding: 20
        spacing: 20
        
        Label:
            text: root.status_message
            font_size: '48sp'
            halign: 'center'
            valign: 'middle'
            text_size: self.size
            color: 0, 1, 0, 1  # Green color
        
        BoxLayout:
            size_hint_y: None
            height: '70dp'
            spacing: 20

            DebouncedButton:
                text: "View Today's Sessions"
                on_release: app.show_today_report_popup()
                background_color: 0, 0.6, 1, 1
            DebouncedButton:
                text: "Edit Today's Sessions"
                on_release: app.edit_today_sessions()
                background_color: 0.2, 0.8, 0.2, 1

# Admin Panel Screen
<AdminScreen>:
    name: "admin"
    ScrollView:
        BoxLayout:
            orientation: "vertical"
            padding: 20
            spacing: 20
            size_hint_y: None
            height: self.minimum_height
            
            Label:
                text: "Admin Panel"
                font_size: '36sp'
                size_hint_y: None
                height: '60dp'
                
            GridLayout:
                cols: 1
                spacing: 20
                size_hint_y: None
                height: self.minimum_height
                
                DebouncedButton:
                    text: "Neuen Benutzer Erfassen"
                    on_release: app.root.current = "register"
                DebouncedButton:
                    text: "RFID-Tag Identifizieren"
                    on_release: app.root.current = "identify"
                DebouncedButton:
                    text: "Work Time Reports"
                    background_color: 0, 0.7, 1, 1  # Blue
                    on_release: app.root.current = "wtreport_select_employee"
                DebouncedButton:
                    text: "LGAV Report (Alle Mitarbeiter)"
                    background_color: 0.2, 0.7, 0.2, 1  # Green
                    on_release: root.export_all_employees_lgav()
                DebouncedButton:
                    text: "L-GAV Import"
                    background_color: 0.7, 0.5, 0.2, 1  # Orange
                    on_release: root.import_lgav()
                DebouncedButton:
                    text: "CSV Export"
                    on_release: root.export_csv()
                DebouncedButton:
                    text: "DB Export"
                    on_release: root.export_database()
                DebouncedButton:
                    text: "Zurück zum Zeit-Terminal"
                    background_color: 1, 0, 0, 1 # Red
                    on_release: app.root.current = "timeclock"

# Identify Tag Screen
<IdentifyScreen>:
    name: "identify"
    BoxLayout:
        orientation: "vertical"
        padding: 20
        spacing: 20
        
        Label:
            text: "Tag zur Identifikation scannen"
            font_size: '32sp'
            size_hint_y: 0.15
            
        ScrollView:
            Label:
                text: root.tag_info
                font_size: '24sp'
                halign: 'center'
                valign: 'middle'
                text_size: self.width, None
                size_hint_y: None
                height: self.texture_size[1] if self.texture_size else '50dp'
            
        DebouncedButton:
            text: "Zurück"
            on_release: app.root.current = "admin"

# Register Employee Screen
<RegisterScreen>:
    name: "register"
    BoxLayout:
        orientation: "vertical"
        padding: 20
        spacing: 20
        
        Label:
            text: "Benutzer Erfassen"
            font_size: '32sp'
            size_hint_y: None
            height: '50dp'
            
        FilteredTextInput:
            id: name_input
            hint_text: "Mitarbeiter Name, z.B. Mike Oxlong"
            multiline: False
            font_size: '24sp'
            size_hint_y: None
            height: '60dp'
            padding: 10
            use_bubble: True
            use_handles: False
            write_tab: False
            password: False
            
        Label:
            text: "Gescannte Tag ID: " + root.tag_id
            font_size: '24sp'
            text_size: self.size
            halign: 'left'
            valign: 'middle'
            
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            spacing: 10
            CheckBox:
                id: admin_checkbox
                active: False
                size_hint_x: 0.2
            Label:
                text: "Ist Admin?"
                halign: 'left'
                text_size: self.size
                valign: 'middle'
                size_hint_x: 0.8

        BoxLayout:
            spacing: 20
            size_hint_y: None
            height: '80dp'
            DebouncedButton:
                text: "Speichern"
                background_color: 0, 1, 0, 1
                on_release: root.save_user()
            DebouncedButton:
                text: "Abbrechen"
                background_color: 1, 0, 0, 1
                on_release: root.cancel()

# Screen 1: Employee Selection
<WTReportSelectEmployeeScreen>:
    name: "wtreport_select_employee"
    
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 20
        
        Label:
            text: "Mitarbeiter Auswählen"
            font_size: '32sp'
            size_hint_y: None
            height: '60dp'
            bold: True
        
        ScrollView:
            size_hint: (1, 1)
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 10
            
            GridLayout:
                id: employee_buttons_container
                cols: 2
                spacing: 10
                size_hint_y: None
                height: self.minimum_height
                row_default_height: '80dp'
                row_force_default: True
                padding: 10
        
        DebouncedButton:
            text: "Zurück"
            font_size: '20sp'
            size_hint_y: None
            height: '70dp'
            background_color: 0.6, 0.2, 0.2, 1
            on_release: app.root.current = "admin"

# Screen 2: Date Range Selection
<WTReportSelectDatesScreen>:
    name: "wtreport_select_dates"
    
    BoxLayout:
        orientation: 'vertical'
        
        # Fixed Header
        Label:
            text: "Work Time Reports"
            font_size: '32sp'
            size_hint_y: None
            height: '60dp'
            bold: True
        
        # Scrollable Content
        ScrollView:
            size_hint: (1, 1)
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 10
            
            BoxLayout:
                orientation: 'vertical'
                padding: 20
                spacing: 20
                size_hint_y: None
                height: self.minimum_height
                
                Label:
                    text: "Mitarbeiter: " + (root.selected_employee.name if root.selected_employee else "Nicht ausgewählt")
                    font_size: '24sp'
                    size_hint_y: None
                    height: '50dp'
                    color: 0, 0.8, 0, 1
                
                GridLayout:
                    cols: 2
                    spacing: 15
                    size_hint_y: None
                    height: '90dp'
                    
                    DebouncedButton:
                        id: start_date_button
                        text: "Von:\\nDatum"
                        halign: 'center'
                        font_size: '22sp'
                        background_color: 0.2, 0.6, 0.9, 1
                        on_release: root.open_start_date_picker()
                
                    DebouncedButton:
                        id: end_date_button
                        text: "Bis:\\nDatum"
                        halign: 'center'
                        font_size: '22sp'
                        background_color: 0.2, 0.6, 0.9, 1
                        on_release: root.open_end_date_picker()
                
                GridLayout:
                    cols: 2
                    spacing: 10
                    size_hint_y: None
                    height: '80dp'
                    
                    DebouncedButton:
                        text: "Bericht Erstellen"
                        font_size: '20sp'
                        background_color: 0, 0.7, 0, 1
                        on_release: root.generate_report()
                    
                    DebouncedButton:
                        text: "CSV Exportieren"
                        font_size: '20sp'
                        background_color: 0, 0.5, 0.9, 1
                        on_release: root.export_report()
                
                Label:
                    text: "L-GAV Export (Art. 15 & 21)"
                    font_size: '18sp'
                    size_hint_y: None
                    height: '40dp'
                    color: 0.8, 0.8, 0, 1
                    bold: True
                
                GridLayout:
                    cols: 3
                    spacing: 10
                    size_hint_y: None
                    height: '80dp'
                    
                    DebouncedButton:
                        text: "L-GAV Excel"
                        font_size: '18sp'
                        background_color: 0.2, 0.7, 0.2, 1
                        on_release: root.export_lgav_excel()
                    
                    DebouncedButton:
                        text: "L-GAV CSV"
                        font_size: '18sp'
                        background_color: 0.2, 0.6, 0.8, 1
                        on_release: root.export_lgav_csv()
                    
                    DebouncedButton:
                        text: "L-GAV PDF"
                        font_size: '18sp'
                        background_color: 0.8, 0.2, 0.2, 1
                        on_release: root.export_lgav_pdf()
        
        # Fixed Footer
        DebouncedButton:
            text: "Zurück"
            font_size: '20sp'
            size_hint_y: None
            height: '70dp'
            background_color: 0.6, 0.2, 0.2, 1
            on_release: app.root.current = "wtreport_select_employee"

# Screen 3: Report Display
<WTReportDisplayScreen>:
    name: "wtreport_display"
    
    BoxLayout:
        orientation: 'vertical'
        padding: 20
        spacing: 20
        
        Label:
            text: "Work Time Report"
            font_size: '32sp'
            size_hint_y: None
            height: '60dp'
            bold: True
        
        Label:
            text: "Mitarbeiter: " + (root.selected_employee.name if root.selected_employee else "Unbekannt")
            font_size: '24sp'
            size_hint_y: None
            height: '50dp'
            color: 0, 0.8, 0, 1
        
        ScrollView:
            size_hint: (1, 1)
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 10
            
            Label:
                id: report_display
                text: ""
                font_size: '16sp'
                halign: 'left'
                valign: 'top'
                text_size: self.width - 20, None
                size_hint_y: None
                height: max(self.texture_size[1], 100) if self.texture_size else 100
        
        Label:
            text: "L-GAV Export (Art. 15 & 21)"
            font_size: '18sp'
            size_hint_y: None
            height: '40dp'
            color: 0.8, 0.8, 0, 1
            bold: True
        
        GridLayout:
            cols: 3
            spacing: 10
            size_hint_y: None
            height: '80dp'
            
            DebouncedButton:
                text: "L-GAV Excel"
                font_size: '18sp'
                background_color: 0.2, 0.7, 0.2, 1
                on_release: root.export_lgav_excel()
            
            DebouncedButton:
                text: "L-GAV CSV"
                font_size: '18sp'
                background_color: 0.2, 0.6, 0.8, 1
                on_release: root.export_lgav_csv()
            
            DebouncedButton:
                text: "L-GAV PDF"
                font_size: '18sp'
                background_color: 0.8, 0.2, 0.2, 1
                on_release: root.export_lgav_pdf()
        
        GridLayout:
            cols: 2
            spacing: 10
            size_hint_y: None
            height: '80dp'
            
            DebouncedButton:
                text: "CSV Exportieren"
                font_size: '20sp'
                background_color: 0, 0.5, 0.9, 1
                on_release: root.export_report()
            
            DebouncedButton:
                text: "Zurück"
                font_size: '20sp'
                background_color: 0.6, 0.2, 0.2, 1
                on_release: app.root.current = "admin"

# Screensaver Screen
<ScreensaverScreen>:
    name: "screensaver"
    MatrixRain:
        id: matrix_bg
    
    FloatLayout:
        Label:
            text: root.time_str
            font_size: '120sp'
            bold: True
            color: 0, 1, 0, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}
            
        Label:
            text: root.date_str
            font_size: '40sp'
            color: 0, 0.8, 0, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.4}
            
        Label:
            text: "Touch to Unlock"
            font_size: '30sp'
            color: 0, 0.6, 0, 0.8
            pos_hint: {'center_x': 0.5, 'center_y': 0.2}
            
    # Transparent button to catch touch anywhere
    DebouncedButton:
        background_color: 0, 0, 0, 0
        size_hint: 1, 1
        on_release: app.reset_idle_timer(force_unlock=True)
